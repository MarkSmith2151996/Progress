/**
 * Interactive credential setup for Progress Tracker
 * Run with: npm run setup
 */

const fs = require('fs');
const path = require('path');
const readline = require('readline');

const ENV_FILE = path.join(__dirname, '..', '.env.local');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

function question(prompt) {
  return new Promise((resolve) => {
    rl.question(prompt, (answer) => {
      resolve(answer.trim());
    });
  });
}

async function main() {
  console.log('\n========================================');
  console.log('  Progress Tracker - Credential Setup');
  console.log('========================================\n');

  // Check for existing .env.local
  if (fs.existsSync(ENV_FILE)) {
    console.log('Found existing .env.local file.\n');
    const overwrite = await question('Overwrite it? (y/N): ');
    if (overwrite.toLowerCase() !== 'y') {
      console.log('\nSetup cancelled. Existing credentials kept.');
      rl.close();
      return;
    }
    console.log('');
  }

  console.log('You\'ll need your Google Service Account credentials.');
  console.log('Get them from: https://console.cloud.google.com/iam-admin/serviceaccounts\n');

  // Get Spreadsheet ID
  console.log('1. SPREADSHEET ID');
  console.log('   Find this in your Google Sheet URL:');
  console.log('   https://docs.google.com/spreadsheets/d/[THIS-PART]/edit\n');
  const spreadsheetId = await question('   Enter Spreadsheet ID: ');

  if (!spreadsheetId) {
    console.log('\nError: Spreadsheet ID is required.');
    rl.close();
    return;
  }

  // Get Client Email
  console.log('\n2. CLIENT EMAIL');
  console.log('   From your service account JSON file (client_email field)');
  console.log('   Looks like: something@project-id.iam.gserviceaccount.com\n');
  const clientEmail = await question('   Enter Client Email: ');

  if (!clientEmail) {
    console.log('\nError: Client Email is required.');
    rl.close();
    return;
  }

  // Get Private Key
  console.log('\n3. PRIVATE KEY');
  console.log('   From your service account JSON file (private_key field)');
  console.log('   Starts with: -----BEGIN PRIVATE KEY-----');
  console.log('   ');
  console.log('   Option A: Paste the JSON file path to extract automatically');
  console.log('   Option B: Paste the private key directly (include BEGIN/END lines)\n');

  const keyInput = await question('   Enter JSON file path OR paste private key: ');

  let privateKey = '';

  if (keyInput.endsWith('.json') || keyInput.includes('\\') || keyInput.includes('/')) {
    // It's a file path
    try {
      const jsonPath = keyInput.replace(/^["']|["']$/g, ''); // Remove quotes if present
      const jsonContent = JSON.parse(fs.readFileSync(jsonPath, 'utf-8'));
      privateKey = jsonContent.private_key;
      console.log('   Key extracted from JSON file.');
    } catch (err) {
      console.log(`\nError reading JSON file: ${err.message}`);
      rl.close();
      return;
    }
  } else if (keyInput.includes('BEGIN PRIVATE KEY')) {
    privateKey = keyInput;
  } else {
    console.log('\nError: Invalid private key format.');
    rl.close();
    return;
  }

  if (!privateKey) {
    console.log('\nError: Private Key is required.');
    rl.close();
    return;
  }

  // Create .env.local content
  const envContent = `# Google Sheets API Credentials
# Generated by setup-credentials.js on ${new Date().toISOString()}

GOOGLE_SHEETS_SPREADSHEET_ID=${spreadsheetId}
GOOGLE_SHEETS_CLIENT_EMAIL=${clientEmail}
GOOGLE_SHEETS_PRIVATE_KEY="${privateKey.replace(/\n/g, '\\n')}"
`;

  // Write the file
  fs.writeFileSync(ENV_FILE, envContent);

  console.log('\n========================================');
  console.log('  Setup Complete!');
  console.log('========================================');
  console.log(`\nCredentials saved to: ${ENV_FILE}`);
  console.log('\nNext steps:');
  console.log('  1. Make sure your Google Sheet is shared with:');
  console.log(`     ${clientEmail}`);
  console.log('  2. Run: npm run desktop:build');
  console.log('  3. Find installer in: dist/Progress Tracker-Setup-0.1.0.exe\n');

  rl.close();
}

main().catch((err) => {
  console.error('Setup failed:', err);
  rl.close();
  process.exit(1);
});
